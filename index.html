<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>çŒ«ç ‚æ·˜æ·˜ä¹</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html,body { width:100%; height:100%; background:#0d0a06; display:flex; align-items:center; justify-content:center; overflow:hidden; touch-action:none; user-select:none; font-family:'PingFang SC','Microsoft YaHei',sans-serif; }
#wrap { position:relative; width:min(420px,100vw); height:min(780px,100dvh); overflow:hidden; background:#c09040; }
#layer-turds,#layer-mask,#layer-fx { position:absolute; inset:0; width:100%; height:100%; }
#layer-turds{z-index:1;} #layer-mask{z-index:2;} #layer-fx{z-index:3;pointer-events:none;}
#topbar { position:absolute; top:0; left:0; right:0; z-index:10; display:flex; align-items:center; justify-content:space-between; padding:10px 14px 8px; background:linear-gradient(to bottom,rgba(0,0,0,.7) 60%,transparent); pointer-events:none; }
#level-info { color:#f5c842; min-width:48px; }
#level-label { font-size:9px; letter-spacing:3px; opacity:.55; }
#level-num { font-size:22px; font-weight:900; line-height:1.1; }
#mid-hud { flex:1; margin:0 10px; display:flex; flex-direction:column; align-items:center; gap:3px; }
#progress-text { font-size:10px; color:rgba(255,255,255,.65); letter-spacing:1px; }
#progress-bar-bg { width:100%; height:7px; background:rgba(0,0,0,.4); border-radius:4px; overflow:hidden; }
#progress-bar-fill { height:100%; width:0%; background:linear-gradient(to right,#f5c842,#ff9900); border-radius:4px; transition:width .5s ease; }
#right-hud { display:flex; flex-direction:column; align-items:flex-end; min-width:60px; }
#score-label,#timer-label { font-size:9px; color:rgba(255,255,255,.45); letter-spacing:2px; }
#score-num { font-size:22px; font-weight:900; color:#f5c842; line-height:1.1; }
#timer-num { font-size:22px; font-weight:900; color:#fff; line-height:1.1; }
#timer-num.danger { color:#ff4444; animation:dangerpulse .5s ease-in-out infinite; }
@keyframes dangerpulse{0%,100%{opacity:1}50%{opacity:.5}}
#sift-btn { position:absolute; z-index:10; bottom:96px; right:14px; width:66px; height:66px; border-radius:50%; background:linear-gradient(145deg,#f5c842,#d4900a); border:none; box-shadow:0 4px 18px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.3); cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:transform .08s,box-shadow .08s; }
#sift-btn:active{transform:scale(.9);}
#sift-btn .si{font-size:24px;line-height:1;} #sift-btn .sl{font-size:9px;font-weight:700;color:#7a4000;letter-spacing:1px;margin-top:1px;}
#tray { position:absolute; bottom:0; left:0; right:0; z-index:10; padding:5px 8px 12px; background:linear-gradient(to top,rgba(0,0,0,.93) 65%,transparent); pointer-events:none; }
#tray-label { font-size:9px; color:rgba(255,255,255,.22); letter-spacing:3px; text-align:center; margin-bottom:4px; }
#slots { display:flex; gap:4px; justify-content:center; }
.slot { width:48px; height:56px; border-radius:11px; background:rgba(255,255,255,.05); border:1.5px solid rgba(255,255,255,.1); display:flex; align-items:center; justify-content:center; font-size:26px; flex-shrink:0; }
.slot.pop{animation:slotpop .22s cubic-bezier(.17,.67,.35,1.6);}
.slot.flash{animation:slotflash .38s ease;}
@keyframes slotpop{0%{transform:scale(0) rotate(-12deg)}100%{transform:scale(1)}}
@keyframes slotflash{0%{background:rgba(245,200,66,.65);transform:scale(1.15)}100%{transform:scale(1)}}
#burst { display:none; position:absolute; z-index:20; pointer-events:none; font-size:24px; font-weight:900; color:#f5c842; text-shadow:0 0 24px rgba(245,200,66,.9); text-align:center; white-space:nowrap; left:50%; top:42%; transform:translate(-50%,-50%); }
@keyframes burstpop{0%{transform:translate(-50%,-50%) scale(0);opacity:0}45%{transform:translate(-50%,-50%) scale(1.2);opacity:1}100%{transform:translate(-50%,-50%) scale(.95);opacity:0}}
.ft { position:absolute; pointer-events:none; z-index:20; font-weight:900; font-size:14px; animation:ftup .75s ease forwards; transform:translateX(-50%); }
@keyframes ftup{0%{transform:translateX(-50%) translateY(0);opacity:1}100%{transform:translateX(-50%) translateY(-55px);opacity:0}}
#rim { position:absolute; inset:0; z-index:9; pointer-events:none; border:4px solid transparent; }
@keyframes rimflash{0%{border-color:rgba(245,200,66,.9);box-shadow:inset 0 0 40px rgba(245,200,66,.2)}100%{border-color:transparent}}
#toast { position:absolute; z-index:30; pointer-events:none; left:50%; bottom:108px; transform:translateX(-50%); background:rgba(0,0,0,.7); color:#fff; border-radius:20px; padding:6px 18px; font-size:12px; white-space:nowrap; opacity:0; transition:opacity .25s; }
#toast.show{opacity:1;}
.screen { display:none; position:absolute; inset:0; z-index:50; flex-direction:column; align-items:center; justify-content:flex-start; background:rgba(8,5,1,.95); backdrop-filter:blur(10px); overflow-y:auto; padding:20px 20px 30px; gap:10px; }
.screen.show{display:flex;}
.screen-center { justify-content:center; }
.btn { padding:12px 32px; background:linear-gradient(135deg,#f5c842,#d4900a); color:#1a0e00; border:none; border-radius:50px; font-size:15px; font-weight:800; cursor:pointer; box-shadow:0 4px 16px rgba(245,200,66,.3); }
.btn-ghost { background:rgba(255,255,255,.08); color:#f5c842; border:1px solid rgba(245,200,66,.25); box-shadow:none; }
.sh2 { font-size:28px; color:#f5c842; font-weight:900; text-align:center; margin-top:10px; }
.sp  { font-size:12px; color:#c8a060; text-align:center; }
.rules-box { width:100%; background:rgba(255,255,255,.05); border-radius:14px; padding:14px 18px; }
.rules-box p { font-size:12px; color:rgba(255,255,255,.72); margin-bottom:5px; }
.rules-box p:last-child{margin-bottom:0;}
.cats-box { width:100%; background:rgba(245,200,66,.07); border-radius:14px; padding:10px 14px; border:1px solid rgba(245,200,66,.15); }
.cats-box-title { font-size:10px; color:#f5c842; letter-spacing:2px; margin-bottom:6px; }
.cats-chips { display:flex; flex-wrap:wrap; gap:6px; }
.cat-chip { font-size:11px; color:rgba(255,255,255,.7); background:rgba(255,255,255,.07); border-radius:8px; padding:3px 8px; }
.settle-row { display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(255,255,255,.06); width:100%; opacity:0; transform:translateX(-20px); transition:opacity .35s,transform .35s; }
.settle-row.show{opacity:1;transform:translateX(0);}
.srl { display:flex; align-items:center; gap:10px; }
.sre { font-size:28px; }
.srn { font-size:13px; color:#fff; font-weight:600; }
.srd { font-size:11px; color:rgba(255,255,255,.45); margin-top:1px; }
.src { font-size:16px; font-weight:800; color:#f5c842; }
.settle-total { width:100%; display:flex; align-items:center; justify-content:space-between; background:rgba(245,200,66,.08); border-radius:12px; padding:14px 16px; margin-top:4px; }
.settle-total-label { font-size:14px; color:rgba(255,255,255,.7); font-weight:600; }
.settle-total-num { font-size:26px; font-weight:900; color:#f5c842; }
.row-btns { display:flex; gap:10px; width:100%; margin-top:4px; }
.row-btns .btn { flex:1; text-align:center; }
.gacha-eggs { display:flex; gap:12px; width:100%; }
.gegg { flex:1; border-radius:18px; padding:16px 10px; display:flex; flex-direction:column; align-items:center; gap:7px; cursor:pointer; transition:transform .1s; border:2px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05); }
.gegg:active{transform:scale(.95);}
.gegg.premium{border-color:rgba(245,200,66,.45);background:rgba(245,200,66,.07);}
.gegg-icon{font-size:46px;line-height:1;}
.gegg-name{font-size:13px;font-weight:700;color:#fff;}
.gegg-price{font-size:12px;color:#f5c842;font-weight:600;}
.gegg-rates{font-size:10px;color:rgba(255,255,255,.38);text-align:center;line-height:1.6;}
.gacha-result-box { width:100%; min-height:90px; display:flex; align-items:center; justify-content:center; }
.grinner { display:none; text-align:center; animation:resultpop .5s cubic-bezier(.17,.67,.35,1.5); }
@keyframes resultpop{0%{transform:scale(0) rotate(-10deg);opacity:0}100%{transform:scale(1);opacity:1}}
.gr-emoji{font-size:60px;line-height:1;}
.gr-name{font-size:17px;font-weight:800;color:#fff;margin-top:4px;}
.gr-rarity{font-size:11px;letter-spacing:2px;margin-top:2px;}
.gr-buff{font-size:12px;color:rgba(255,255,255,.55);margin-top:3px;}
.rn{color:rgba(255,255,255,.45);} .rr{color:#60c0ff;} .rs{color:#f5c842;}
.owned-section { width:100%; }
.owned-title { font-size:10px; color:rgba(255,255,255,.3); letter-spacing:3px; margin-bottom:8px; }
.owned-list { display:flex; flex-wrap:wrap; gap:6px; }
.ocat { font-size:11px; color:rgba(255,255,255,.7); background:rgba(255,255,255,.06); border-radius:8px; padding:4px 8px; }
.ocat .st{color:#f5c842;font-size:9px;}
#gacha-coins-bar { font-size:13px; color:#c8a060; text-align:center; }
#gacha-coins-bar span{color:#f5c842;font-weight:800;}
#gacha-anim { display:none; position:absolute; inset:0; z-index:60; background:rgba(0,0,0,.88); flex-direction:column; align-items:center; justify-content:center; gap:16px; }
#gacha-anim.show{display:flex;}
#gball{font-size:80px;animation:ballspin .8s ease-in-out infinite;}
@keyframes ballspin{0%{transform:rotate(-15deg) scale(1)}50%{transform:rotate(15deg) scale(1.1)}100%{transform:rotate(-15deg) scale(1)}}
#gtext{font-size:15px;color:#f5c842;letter-spacing:3px;animation:blink .6s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:.4}50%{opacity:1}}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="layer-turds"></canvas>
  <canvas id="layer-mask"></canvas>
  <canvas id="layer-fx"></canvas>
  <div id="topbar">
    <div id="level-info"><div id="level-label">STAGE</div><div id="level-num">1</div></div>
    <div id="mid-hud">
      <div id="progress-text">0 / 0 ç»„</div>
      <div id="progress-bar-bg"><div id="progress-bar-fill"></div></div>
    </div>
    <div id="right-hud">
      <div id="score-label">SCORE</div><div id="score-num">0</div>
      <div id="timer-label" style="display:none">TIME</div><div id="timer-num" style="display:none">0</div>
    </div>
  </div>
  <button id="sift-btn"><span class="si">ğŸ¾</span><span class="sl">é“²ä¸€é“²</span></button>
  <div id="tray"><div id="tray-label">æ”¶é›†æ§½</div><div id="slots"></div></div>
  <div id="rim"></div><div id="burst"></div><div id="toast"></div>

  <!-- INTRO -->
  <div class="screen screen-center" id="s-intro">
    <div class="sh2" id="i-title">ç¬¬1å…³</div>
    <div class="sp" id="i-badge"></div>
    <div class="rules-box" id="i-rules"></div>
    <div class="cats-box" id="i-cats" style="display:none">
      <div class="cats-box-title">âœ¨ å·²æ¿€æ´»BUFF</div>
      <div class="cats-chips" id="i-cats-list"></div>
    </div>
    <button class="btn" onclick="startLevel()">å¼€å§‹é“²å±ï¼ğŸ¾</button>
  </div>

  <!-- SETTLE -->
  <div class="screen" id="s-settle">
    <div class="sh2">âœ¨ å…³å¡å®Œæˆï¼</div>
    <div class="sp" id="st-sub"></div>
    <div id="st-rows"></div>
    <div id="st-buff" style="font-size:11px;color:#f5c842;background:rgba(245,200,66,.1);border-radius:8px;padding:6px 12px;text-align:center;display:none;width:100%"></div>
    <div class="settle-total"><div class="settle-total-label">ğŸ’° åˆè®¡é‡‘å¸</div><div class="settle-total-num" id="st-total">0</div></div>
    <div class="row-btns">
      <button class="btn" onclick="showGacha()">å»æ‰­è›‹ ğŸ°</button>
      <button class="btn btn-ghost" onclick="goNextLevel()">ä¸‹ä¸€å…³ â†’</button>
    </div>
  </div>

  <!-- GACHA -->
  <div class="screen" id="s-gacha">
    <div class="sh2" style="margin-top:0">ğŸ° æ‰­è›‹æœº</div>
    <div id="gacha-coins-bar">å½“å‰é‡‘å¸ï¼š<span id="gc-num">0</span></div>
    <div class="gacha-eggs">
      <div class="gegg" onclick="doGacha(false)">
        <div class="gegg-icon">ğŸ¥š</div>
        <div class="gegg-name">æ™®é€šæ‰­è›‹</div>
        <div class="gegg-price">100 ğŸ’°</div>
        <div class="gegg-rates">æ™®é€š 60%<br>ç¨€æœ‰ 35%<br>è¶…ç¨€æœ‰ 5%</div>
      </div>
      <div class="gegg premium" onclick="doGacha(true)">
        <div class="gegg-icon">ğŸ</div>
        <div class="gegg-name">è±ªåæ‰­è›‹</div>
        <div class="gegg-price">1000 ğŸ’°</div>
        <div class="gegg-rates">æ™®é€š 20%<br>ç¨€æœ‰ 55%<br>è¶…ç¨€æœ‰ 25%</div>
      </div>
    </div>
    <div class="gacha-result-box"><div class="grinner" id="gr-inner">
      <div class="gr-emoji" id="gr-emoji"></div>
      <div class="gr-name" id="gr-name"></div>
      <div class="gr-rarity" id="gr-rarity"></div>
      <div class="gr-buff" id="gr-buff"></div>
    </div></div>
    <div class="owned-section">
      <div class="owned-title">å·²æ‹¥æœ‰çš„çŒ«</div>
      <div class="owned-list" id="owned-list"></div>
    </div>
    <div class="row-btns" style="margin-top:auto">
      <button class="btn btn-ghost" onclick="goNextLevel()">å¼€å§‹ä¸‹ä¸€å…³ â†’</button>
    </div>
  </div>

  <!-- GAMEOVER -->
  <div class="screen screen-center" id="s-gameover">
    <div class="sh2" style="color:#ff6644">ğŸ’€ æŒ‘æˆ˜å¤±è´¥ï¼</div>
    <div class="sp" id="go-info"></div>
    <div class="row-btns" style="margin-top:14px">
      <button class="btn" onclick="showIntro(currentLevel)">é‡è¯•</button>
      <button class="btn btn-ghost" onclick="showIntro(1)">ç¬¬ä¸€å…³</button>
    </div>
  </div>

  <!-- GACHA ANIM -->
  <div id="gacha-anim"><div id="gball">ğŸ¥š</div><div id="gtext">æ‰­è›‹ä¸­...</div></div>
</div>
<script>
const TURDS=[
  {id:0,emoji:'ğŸ’©',name:'æ™®é€šä¾¿',color:'#8B4513',dark:'#4a2008',price:10},
  {id:1,emoji:'ğŸŒ½',name:'ç‰ç±³ä¾¿',color:'#c8a020',dark:'#806000',price:15},
  {id:2,emoji:'ğŸŸ¤',name:'åœ†çƒä¾¿',color:'#A0522D',dark:'#5a2810',price:25},
  {id:3,emoji:'ğŸ«˜',name:'è±†è±†ä¾¿',color:'#6B3A2A',dark:'#351508',price:40},
  {id:4,emoji:'âš«',name:'é»‘ä¾¿',  color:'#2d2018',dark:'#0a0806',price:60},
  {id:5,emoji:'ğŸ”´',name:'è¡€ä¾¿',  color:'#8B0000',dark:'#4a0000',price:80},
  {id:6,emoji:'â­',name:'ç¨€æœ‰ä¾¿',color:'#B8860B',dark:'#7a5500',price:100},
  {id:7,emoji:'ğŸ’',name:'é’»çŸ³ä¾¿',color:'#4a90d9',dark:'#1a4a80',price:150},
  {id:8,emoji:'â˜•',name:'å’–å•¡è±†å±',color:'#4a2800',dark:'#1a0800',price:300},
  {id:9,emoji:'ğŸ¥‡',name:'å…ƒå®å±',color:'#d4a820',dark:'#8a6000',price:500},
];
const CATS=[
  {id:0,emoji:'ğŸ±',name:'æ©˜çŒ«',  rarity:'normal',buff:'æ™®é€šä¾¿å”®ä»·Ã—1.5',  fn:b=>{b.pm[0]=1.5;}},
  {id:1,emoji:'ğŸˆ', name:'ç‹¸èŠ±çŒ«',rarity:'normal',buff:'æ¯é“²å¤šéœ²1å¨',    fn:b=>{b.er+=1;}},
  {id:2,emoji:'ğŸ¤',name:'ç™½çŒ«',  rarity:'normal',buff:'æ§½ä½æ‰©å±•è‡³7æ ¼',  fn:b=>{b.ms=7;}},
  {id:3,emoji:'ğŸˆâ€â¬›',name:'é»‘çŒ«', rarity:'normal',buff:'é™æ—¶+20ç§’',     fn:b=>{b.bt+=20;}},
  {id:4,emoji:'ğŸ˜º',name:'å¸ƒå¶çŒ«',rarity:'normal',buff:'åœ†çƒ+è±†è±†ä¾¿Ã—1.5',fn:b=>{b.pm[2]=1.5;b.pm[3]=1.5;}},
  {id:5,emoji:'ğŸ¦',name:'ç¼…å› çŒ«',rarity:'rare',  buff:'é»‘ä¾¿+ç¨€æœ‰ä¾¿Ã—2',  fn:b=>{b.pm[4]=2;b.pm[6]=2;}},
  {id:6,emoji:'ğŸ‘‘',name:'é‡‘æ¸å±‚',rarity:'rare',  buff:'ç»“ç®—é‡‘å¸Ã—1.3',   fn:b=>{b.sm=1.3;}},
  {id:7,emoji:'ğŸŒ™',name:'ä¿„è“çŒ«',rarity:'rare',  buff:'é™æ—¶+30ç§’',      fn:b=>{b.bt+=30;}},
  {id:8,emoji:'ğŸ¦¡',name:'éºé¦™çŒ«',rarity:'super', buff:'æ¦‚ç‡å‡ºâ˜•å’–å•¡è±†å±',fn:b=>{b.ss.push(8);}},
  {id:9,emoji:'ğŸ†',name:'æ‹›è´¢çŒ«',rarity:'super', buff:'æ¦‚ç‡å‡ºğŸ¥‡å…ƒå®å±', fn:b=>{b.ss.push(9);}},
];
const RL={normal:'æ™®é€š',rare:'ç¨€æœ‰',super:'è¶…ç¨€æœ‰'};
const RC={normal:'rn',rare:'rr',super:'rs'};
const STAGE_CFGS=[
  {tc:3,ge:2,timed:false,ts:0},
  {tc:5,ge:3,timed:true, ts:180},
  {tc:7,ge:4,timed:true, ts:240},
  {tc:8,ge:5,timed:true, ts:300},
  {tc:8,ge:6,timed:true, ts:330},
];

let W,H,ctxT,ctxM,ctxF;
let turds=[],slots=[],particles=[],sandNoise=[];
let currentLevel=1,stageCfg=null,totalGroups=0;
let score=0,eliminated=0,timeLeft=0;
let timerInterval=null,frameId=null,gameRunning=false;
let siftShake=0,frameCount=0,motionEnabled=false,lastMotionT=0;
const TH=66,BH=78;
let playerCoins=0,ownedCats={};
let B={};

function resetB(){B={pm:{0:1,1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:1,9:1},er:0,ms:6,bt:0,sm:1,ss:[]};}
function applyB(){
  resetB();
  for(const[id,stars] of Object.entries(ownedCats))
    for(let s=0;s<stars;s++) CATS[+id].fn(B);
}

const wrap=document.getElementById('wrap');
function ct(){return document.getElementById('layer-turds');}
function cm(){return document.getElementById('layer-mask');}
function cf(){return document.getElementById('layer-fx');}

function init(){
  resize();
  ctxT=ct().getContext('2d'); ctxM=cm().getContext('2d'); ctxF=cf().getContext('2d');
  makeSandNoise(); setupInput(); showIntro(1);
}
function resize(){
  W=wrap.clientWidth; H=wrap.clientHeight;
  ['layer-turds','layer-mask','layer-fx'].forEach(id=>{const c=document.getElementById(id);c.width=W;c.height=H;});
}
function makeSandNoise(){
  sandNoise=[];
  const cols=Math.ceil(W/7)+2,rows=Math.ceil(H/7)+2;
  for(let r=0;r<rows;r++){sandNoise.push([]);for(let c=0;c<cols;c++)sandNoise[r].push(Math.random());}
}
function hideAll(){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('show'));}

function getStageCfg(lvl){
  if(lvl<=STAGE_CFGS.length) return STAGE_CFGS[lvl-1];
  const ex=lvl-STAGE_CFGS.length;
  return{tc:8,ge:6+ex*2,timed:true,ts:Math.min(330+ex*30,600)};
}
function fmtTime(s){return s>=60?`${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`:String(s);}

function showIntro(lvl){
  stopTimer(); gameRunning=false; currentLevel=lvl;
  stageCfg=getStageCfg(lvl); applyB();
  totalGroups=stageCfg.tc*stageCfg.ge;
  const total=stageCfg.tc*stageCfg.ge*3;
  document.getElementById('i-title').textContent=`ç¬¬${lvl}å…³`;
  document.getElementById('i-badge').textContent=stageCfg.timed?`é™æ—¶ ${fmtTime(stageCfg.ts+B.bt)}`:'æ–°æ‰‹å…³ Â· æ— æ—¶é™';
  const rules=[];
  rules.push(`â€¢ ${stageCfg.tc}ç§çŒ«å±ï¼Œæ¯ç§ ${stageCfg.ge*3} å¨ï¼ˆ${stageCfg.ge}ç»„ï¼‰`);
  rules.push(`â€¢ å…± ${total} å¨ï¼Œå…¨éƒ¨æ¶ˆé™¤é€šå…³`);
  if(stageCfg.timed) rules.push(`â€¢ é™æ—¶ ${fmtTime(stageCfg.ts+B.bt)}`);
  rules.push('â€¢ é“²ä¸€é“²ç¿»å‡ºçŒ«å±ï¼Œå‡‘3ä¸ªæ¶ˆé™¤ï¼');
  document.getElementById('i-rules').innerHTML=rules.map(r=>`<p>${r}</p>`).join('');
  const ck=Object.keys(ownedCats);
  const cbox=document.getElementById('i-cats');
  if(ck.length){cbox.style.display='block';document.getElementById('i-cats-list').innerHTML=ck.map(id=>`<div class="cat-chip">${CATS[+id].emoji}${'â­'.repeat(ownedCats[id])} ${CATS[+id].name}</div>`).join('');}
  else cbox.style.display='none';
  hideAll(); document.getElementById('s-intro').classList.add('show');
}

function startLevel(){
  hideAll(); gameRunning=true;
  slots=[]; score=0; eliminated=0; particles=[]; applyB();
  document.getElementById('level-num').textContent=currentLevel;
  document.getElementById('score-num').textContent='0';
  const timed=stageCfg.timed;
  document.getElementById('score-label').style.display=timed?'none':'block';
  document.getElementById('score-num').style.display=timed?'none':'block';
  document.getElementById('timer-label').style.display=timed?'block':'none';
  document.getElementById('timer-num').style.display=timed?'block':'none';
  if(timed){timeLeft=stageCfg.ts+B.bt;updateTimerUI();startTimer();}
  totalGroups=stageCfg.tc*stageCfg.ge;
  updateProgress(); makeTurds(); makeSandNoise(); renderSlots();
  if(frameId) cancelAnimationFrame(frameId);
  loop();
}
function goNextLevel(){showIntro(currentLevel+1);}

function makeTurds(){
  turds=[];
  // Build strictly balanced type array: each type exactly ge*3 times
  const ids=[];
  for(let t=0;t<stageCfg.tc;t++) for(let g=0;g<stageCfg.ge*3;g++) ids.push(t);
  // shuffle
  for(let i=ids.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[ids[i],ids[j]]=[ids[j],ids[i]];}
  const pw=W,ph=H-BH-TH,mg=36;
  for(let i=0;i<ids.length;i++){
    let x,y,r=17+Math.random()*10,placed=false,tries=0;
    while(!placed&&tries<150){
      x=mg+Math.random()*(pw-mg*2); y=TH+mg+Math.random()*(ph-mg*2);
      let ok=true;
      for(const t of turds){if(Math.hypot(t.x-x,t.y-y)<t.r+r+8){ok=false;break;}}
      if(ok)placed=true; tries++;
    }
    // small chance of special turd from buff
    let tid=ids[i];
    if(B.ss.length>0&&Math.random()<0.04) tid=B.ss[Math.floor(Math.random()*B.ss.length)];
    turds.push({typeId:tid,x,y,r,angle:Math.random()*Math.PI*2,depth:1.0,targetDepth:1.0,collected:false});
  }
}

function sift(){
  if(!gameRunning) return;
  siftShake=1.0; rimFlash();
  if(navigator.vibrate) navigator.vibrate(35);
  for(const row of sandNoise) for(let i=0;i<row.length;i++) if(Math.random()<.28) row[i]=Math.random();
  const rc=2+B.er;
  const buried=turds.filter(t=>!t.collected&&t.depth>0.55);
  buried.sort(()=>Math.random()-.5);
  for(let i=0;i<Math.min(rc,buried.length);i++) buried[i].targetDepth=Math.max(0,buried[i].depth-(0.28+Math.random()*0.45));
  for(let i=0;i<30;i++) particles.push({x:Math.random()*W,y:TH+20+Math.random()*(H-TH-BH-40),vx:(Math.random()-.5)*7,vy:(Math.random()-.5)*7,r:2+Math.random()*4,life:1,color:`hsl(${28+Math.random()*18},50%,${35+Math.random()*15}%)`});
}

function tryCollect(px,py){
  if(!gameRunning||py<TH||py>H-BH) return;
  let best=null,bd=Infinity;
  for(const t of turds){
    if(t.collected||t.depth>0.72) continue;
    const d=Math.hypot(t.x-px,t.y-py);
    if(d<t.r*2.5&&d<bd){best=t;bd=d;}
  }
  if(!best){
    for(const t of turds) if(!t.collected&&Math.hypot(t.x-px,t.y-py)<t.r*2.2){showToast('å†é“²å‡ æ¬¡å°±å‡ºæ¥å•¦ï¼');return;}
    return;
  }
  if(slots.length>=B.ms){triggerGameOver('æ§½ä½å·²æ»¡ï¼');return;}
  best.collected=true; slots.push(best.typeId);
  spawnFT(best.x,best.y-best.r,'+1');
  if(navigator.vibrate) navigator.vibrate(12);
  renderSlots(); checkMatch();
}

function checkMatch(){
  const counts={};
  for(const id of slots) counts[id]=(counts[id]||0)+1;
  for(const[id,n] of Object.entries(counts)){
    if(n>=3){
      let rem=0;
      slots=slots.filter(s=>(s===+id&&rem<3)?(rem++,false):true);
      eliminated+=3;
      const earned=Math.round(TURDS[+id].price*(B.pm[+id]||1))*3;
      score+=earned;
      document.getElementById('score-num').textContent=score;
      showBurst(TURDS[+id].emoji,earned);
      spawnMP(W/2,H-BH-30,TURDS[+id].color);
      flashSlots(); if(navigator.vibrate) navigator.vibrate([30,15,60]);
      updateProgress(); renderSlots();
      // win check: all turds collected AND slots empty
      const remaining=turds.filter(t=>!t.collected&&t.typeId<8).length;
      if(remaining===0&&slots.length===0){setTimeout(doStageClear,400);return;}
      setTimeout(checkMatch,280); return;
    }
  }
}

function doStageClear(){
  stopTimer(); gameRunning=false;
  const final=Math.round(score*B.sm);
  playerCoins+=final; showSettle(final);
}

function showSettle(final){
  hideAll();
  document.getElementById('st-sub').textContent=`ç¬¬${currentLevel}å…³å®Œæˆï¼æ¶ˆé™¤äº† ${eliminated} å¨çŒ«å±`;
  const collected={};
  for(const t of turds) if(t.collected) collected[t.typeId]=(collected[t.typeId]||0)+1;
  const rowsEl=document.getElementById('st-rows'); rowsEl.innerHTML='';
  const entries=Object.entries(collected).sort((a,b)=>+a[0]-+b[0]);
  entries.forEach(([id,count],idx)=>{
    const type=TURDS[+id],multi=B.pm[+id]||1,sub=Math.round(type.price*multi)*count;
    const row=document.createElement('div'); row.className='settle-row';
    row.innerHTML=`<div class="srl"><div class="sre">${type.emoji}</div><div><div class="srn">${type.name}</div><div class="srd">${count}å¨ Ã— ${Math.round(type.price*multi)}ğŸ’°${multi>1?` (Ã—${multi})`:''}</div></div></div><div class="src">+${sub}</div>`;
    rowsEl.appendChild(row);
    setTimeout(()=>row.classList.add('show'),(idx+1)*180);
  });
  const buffEl=document.getElementById('st-buff');
  if(B.sm>1){buffEl.style.display='block';buffEl.textContent=`ğŸ‘‘ é‡‘æ¸å±‚åŠ æˆ Ã—${B.sm} â†’ æœ€ç»ˆ ${final} ğŸ’°`;}
  else buffEl.style.display='none';
  const totalEl=document.getElementById('st-total'); totalEl.textContent='0';
  const delay=entries.length*180+400;
  setTimeout(()=>{let cur=0;const step=Math.ceil(final/40);const iv=setInterval(()=>{cur=Math.min(cur+step,final);totalEl.textContent=cur;if(cur>=final)clearInterval(iv);},30);},delay);
  document.getElementById('s-settle').classList.add('show');
}

function showGacha(){
  hideAll(); updateGachaUI();
  document.getElementById('s-gacha').classList.add('show');
}

function doGacha(premium){
  const cost=premium?1000:100;
  if(playerCoins<cost){showToast('é‡‘å¸ä¸è¶³ï¼');return;}
  playerCoins-=cost;
  const anim=document.getElementById('gacha-anim');
  anim.classList.add('show');
  document.getElementById('gball').textContent=premium?'ğŸ':'ğŸ¥š';
  setTimeout(()=>{
    anim.classList.remove('show');
    const cat=rollCat(premium);
    ownedCats[cat.id]=ownedCats[cat.id]===undefined?1:Math.min(3,ownedCats[cat.id]+1);
    showGResult(cat); updateGachaUI();
  },1200);
}
function rollCat(premium){
  const r=Math.random(),pool=rarity=>{return CATS.filter(c=>c.rarity===rarity);};
  let p;
  if(premium){p=r<0.25?pool('super'):r<0.80?pool('rare'):pool('normal');}
  else{p=r<0.05?pool('super'):r<0.40?pool('rare'):pool('normal');}
  return p[Math.floor(Math.random()*p.length)];
}
function showGResult(cat){
  const ri=document.getElementById('gr-inner');
  ri.style.display='block'; ri.style.animation='none'; void ri.offsetWidth; ri.style.animation='resultpop .5s cubic-bezier(.17,.67,.35,1.5)';
  document.getElementById('gr-emoji').textContent=cat.emoji;
  document.getElementById('gr-name').textContent=cat.name;
  const rl=document.getElementById('gr-rarity'); rl.textContent=RL[cat.rarity]; rl.className='gr-rarity '+RC[cat.rarity];
  document.getElementById('gr-buff').textContent=cat.buff;
  if(navigator.vibrate) navigator.vibrate([50,30,100]);
}
function updateGachaUI(){
  document.getElementById('gc-num').textContent=playerCoins;
  const list=document.getElementById('owned-list'); list.innerHTML='';
  const keys=Object.keys(ownedCats);
  if(!keys.length){list.innerHTML='<div style="font-size:11px;color:rgba(255,255,255,.28)">è¿˜æ²¡æœ‰çŒ«ï¼Œå¿«å»æ‰­ï¼</div>';return;}
  for(const[id,stars] of Object.entries(ownedCats)){
    const cat=CATS[+id],el=document.createElement('div');
    el.className='ocat'; el.innerHTML=`${cat.emoji} ${cat.name} <span class="st">${'â­'.repeat(stars)}</span>`;
    list.appendChild(el);
  }
}
function triggerGameOver(reason){
  stopTimer(); gameRunning=false; hideAll();
  document.getElementById('s-gameover').classList.add('show');
  document.getElementById('go-info').textContent=reason||`æ¶ˆé™¤äº† ${eliminated} å¨ï¼Œå†æ¥å†å‰ï¼`;
}

function startTimer(){stopTimer();timerInterval=setInterval(()=>{if(!gameRunning)return;timeLeft--;updateTimerUI();if(timeLeft<=0)triggerGameOver('æ—¶é—´åˆ°äº†ï¼');},1000);}
function stopTimer(){clearInterval(timerInterval);timerInterval=null;}
function updateTimerUI(){document.getElementById('timer-num').textContent=fmtTime(timeLeft);document.getElementById('timer-num').className=timeLeft<=15?'danger':'';}
function updateProgress(){
  const eg=Math.floor(eliminated/3);
  const pct=Math.floor(eg/totalGroups*100);
  document.getElementById('progress-text').textContent=`${eg} / ${totalGroups} ç»„`;
  document.getElementById('progress-bar-fill').style.width=pct+'%';
}

function loop(){frameId=requestAnimationFrame(loop);frameCount++;update();drawT();drawM();drawF();}
function update(){
  if(siftShake>0) siftShake=Math.max(0,siftShake-.055);
  for(const t of turds) if(!t.collected&&t.depth>t.targetDepth) t.depth=Math.max(t.targetDepth,t.depth-.022);
  for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.x+=p.vx;p.y+=p.vy;p.vx*=.88;p.vy*=.88;p.life-=.032;if(p.life<=0)particles.splice(i,1);}
}
function drawT(){
  ctxT.clearRect(0,0,W,H);
  for(const t of turds) if(!t.collected) drawOneTurd(ctxT,t);
}
function drawOneTurd(ctx,t){
  ctx.save(); ctx.translate(t.x,t.y); ctx.rotate(t.angle);
  const r=t.r,tp=TURDS[t.typeId];
  ctx.shadowColor='rgba(0,0,0,.55)'; ctx.shadowBlur=10; ctx.shadowOffsetY=5;
  const gr=ctx.createRadialGradient(-r*.3,-r*.3,r*.05,0,0,r*1.1);
  gr.addColorStop(0,ltn(tp.color,55)); gr.addColorStop(.55,tp.color); gr.addColorStop(1,tp.dark);
  ctx.fillStyle=gr; ctx.beginPath(); drawShp(ctx,t.typeId,r); ctx.fill();
  ctx.shadowBlur=0; ctx.shadowOffsetY=0;
  ctx.beginPath(); ctx.ellipse(-r*.22,-r*.3,r*.24,r*.15,-.5,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,.3)'; ctx.fill();
  ctx.font=`${r}px serif`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.globalAlpha=.82; ctx.fillText(tp.emoji,0,1);
  ctx.restore();
}
function drawShp(ctx,tid,r){
  switch(tid%8){
    case 0:ctx.moveTo(0,r);ctx.bezierCurveTo(r*1.1,r*.8,r*1.1,-r*.2,r*.4,-r*.3);ctx.bezierCurveTo(r*.9,-r*.7,r*.4,-r*1.1,0,-r);ctx.bezierCurveTo(-r*.4,-r*1.1,-r*.9,-r*.7,-r*.4,-r*.3);ctx.bezierCurveTo(-r*1.1,-r*.2,-r*1.1,r*.8,0,r);break;
    case 1:ctx.arc(0,0,r,0,Math.PI*2);break;
    case 2:ctx.ellipse(0,0,r*.72,r,.3,0,Math.PI*2);break;
    case 3:for(let i=0;i<8;i++){const a=(i/8)*Math.PI*2-Math.PI/2,ir=r*(.68+Math.sin(i*2.1)*.22);i===0?ctx.moveTo(Math.cos(a)*ir,Math.sin(a)*ir):ctx.lineTo(Math.cos(a)*ir,Math.sin(a)*ir);}ctx.closePath();break;
    case 4:for(let i=0;i<5;i++){const a=(i/5)*Math.PI*2-Math.PI/2,ia=a+Math.PI/5;i===0?ctx.moveTo(Math.cos(a)*r,Math.sin(a)*r):ctx.lineTo(Math.cos(a)*r,Math.sin(a)*r);ctx.lineTo(Math.cos(ia)*r*.42,Math.sin(ia)*r*.42);}ctx.closePath();break;
    case 5:ctx.arc(0,0,r,0,Math.PI*2);break;
    case 6:ctx.ellipse(0,0,r*.8,r,0,0,Math.PI*2);break;
    case 7:for(let i=0;i<6;i++){const a=(i/6)*Math.PI*2-Math.PI/2;i===0?ctx.moveTo(Math.cos(a)*r,Math.sin(a)*r):ctx.lineTo(Math.cos(a)*r,Math.sin(a)*r);}ctx.closePath();break;
  }
}
function drawM(){
  ctxM.clearRect(0,0,W,H);
  const g=ctxM.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#d4a855');g.addColorStop(.5,'#b88838');g.addColorStop(1,'#8a6020');
  ctxM.fillStyle=g;ctxM.fillRect(0,0,W,H);
  const sh=siftShake;
  ctxM.save();ctxM.globalAlpha=.2;
  for(let r=0;r<sandNoise.length;r++)for(let c=0;c<sandNoise[r].length;c++){
    const v=sandNoise[r][c],dx=sh*(Math.random()-.5)*9,dy=sh*(Math.random()-.5)*9;
    if(v>.63){ctxM.fillStyle='rgba(255,215,110,.9)';ctxM.fillRect(c*7+dx,r*7+dy,2,2);}
    else if(v<.22){ctxM.fillStyle='rgba(60,30,5,.85)';ctxM.fillRect(c*7+dx,r*7+dy,2,2);}
  }
  ctxM.restore();
  ctxM.save();ctxM.globalAlpha=.07;ctxM.strokeStyle='#6a4010';ctxM.lineWidth=1;
  for(let y=TH+5;y<H-BH;y+=18){ctxM.beginPath();ctxM.moveTo(0,y);for(let x=0;x<W;x+=24){ctxM.lineTo(x+12,y+4+Math.sin(x*.06+frameCount*.01)*3);ctxM.lineTo(x+24,y);}ctxM.stroke();}
  ctxM.restore();
  ctxM.globalCompositeOperation='destination-out';
  for(const t of turds){
    if(t.collected||t.depth>=1.0)continue;
    const ex=1.0-t.depth;if(ex<0.02)continue;
    const hr=t.r*ex*1.75;
    const hg=ctxM.createRadialGradient(t.x,t.y,hr*.2,t.x,t.y,hr);
    hg.addColorStop(0,'rgba(0,0,0,1)');hg.addColorStop(.6,'rgba(0,0,0,.92)');hg.addColorStop(1,'rgba(0,0,0,0)');
    ctxM.beginPath();ctxM.arc(t.x,t.y,hr,0,Math.PI*2);ctxM.fillStyle=hg;ctxM.fill();
  }
  ctxM.globalCompositeOperation='source-over';
  ctxM.clearRect(0,0,W,TH);ctxM.clearRect(0,H-BH,W,BH);
}
function drawF(){
  ctxF.clearRect(0,0,W,H);
  if(siftShake>.05){ctxF.fillStyle=`rgba(200,160,60,${siftShake*.13})`;ctxF.fillRect(0,0,W,H);}
  for(const p of particles){ctxF.globalAlpha=p.life;ctxF.beginPath();ctxF.arc(p.x,p.y,p.r,0,Math.PI*2);ctxF.fillStyle=p.color;ctxF.fill();}
  ctxF.globalAlpha=1;
}

function renderSlots(){
  const sl=document.getElementById('slots');sl.innerHTML='';
  for(let i=0;i<B.ms;i++){const d=document.createElement('div');d.className='slot';if(slots[i]!==undefined){d.textContent=TURDS[slots[i]].emoji;d.classList.add('pop');}sl.appendChild(d);}
}
function flashSlots(){document.querySelectorAll('.slot').forEach(s=>{s.classList.remove('flash');void s.offsetWidth;s.classList.add('flash');});}
function showBurst(e,p){const b=document.getElementById('burst');b.style.display='block';b.style.animation='none';b.textContent=`${e}Ã—3  +${p}ğŸ’°`;void b.offsetWidth;b.style.animation='burstpop .75s ease forwards';setTimeout(()=>b.style.display='none',850);}
function spawnFT(x,y,t){const el=document.createElement('div');el.className='ft';el.style.cssText=`left:${x}px;top:${y}px;color:#f5c842;`;el.textContent=t;wrap.appendChild(el);setTimeout(()=>el.remove(),800);}
function spawnMP(x,y,color){for(let i=0;i<22;i++)particles.push({x,y,vx:(Math.random()-.5)*10,vy:-(2+Math.random()*8),r:3+Math.random()*5,life:1,color});}
function rimFlash(){const r=document.getElementById('rim');r.style.animation='none';void r.offsetWidth;r.style.animation='rimflash .4s ease forwards';}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(showToast._t);showToast._t=setTimeout(()=>t.classList.remove('show'),1800);}
function ltn(h,a){return `rgb(${Math.min(255,parseInt(h.slice(1,3),16)+a)},${Math.min(255,parseInt(h.slice(3,5),16)+a)},${Math.min(255,parseInt(h.slice(5,7),16)+a)})`;}

function setupInput(){
  const sb=document.getElementById('sift-btn');
  sb.addEventListener('touchstart',e=>{e.preventDefault();e.stopPropagation();sift();},{passive:false});
  sb.addEventListener('click',e=>{e.stopPropagation();sift();});
  function gxy(e){const r=cm().getBoundingClientRect(),sx=W/r.width,sy=H/r.height,s=e.touches?e.touches[0]:e;return{x:(s.clientX-r.left)*sx,y:(s.clientY-r.top)*sy};}
  function onTap(e){e.preventDefault();const{x,y}=gxy(e);tryCollect(x,y);}
  cm().addEventListener('touchstart',onTap,{passive:false});
  cm().addEventListener('mousedown',onTap);
  if(typeof DeviceMotionEvent!=='undefined'&&typeof DeviceMotionEvent.requestPermission==='function'){
    sb.addEventListener('touchend',async()=>{if(!motionEnabled){try{const r=await DeviceMotionEvent.requestPermission();if(r==='granted')enableMotion();}catch(e){}}});
  } else enableMotion();
}
function enableMotion(){
  motionEnabled=true;
  window.addEventListener('devicemotion',e=>{
    const a=e.accelerationIncludingGravity;if(!a)return;
    const mag=Math.sqrt((a.x||0)**2+(a.y||0)**2+(a.z||0)**2),now=Date.now();
    if(mag>20&&now-lastMotionT>700){lastMotionT=now;sift();}
  });
}
window.addEventListener('resize',()=>{resize();ctxT=ct().getContext('2d');ctxM=cm().getContext('2d');ctxF=cf().getContext('2d');makeSandNoise();});
init();
</script>
</body>
</html>
